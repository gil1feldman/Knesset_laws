<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8">
  <title>הצעות חוק - הכנסת ה-25</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; direction: rtl; padding: 20px; }
    input, select, button { margin: 5px; padding: 5px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; table-layout: fixed; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: right; overflow-wrap: break-word; }
    th { background-color: #f2f2f2; }
    #lastUpdate { margin-top: 10px; font-weight: bold; }
    .proposer-cell { max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; position: relative; }
    .more-proposers { display: none; position: absolute; background: #fff; border: 1px solid #ccc; padding: 5px; z-index: 10; }
    .show-more-btn { cursor: pointer; color: blue; border: none; background: none; text-decoration: underline; }
  </style>
</head>
<body>
  <h1>הצעות חוק - הכנסת ה-25</h1>
  <div id="lastUpdate">עדכני לתאריך: טוען...</div>
  <div>
    <input type="text" id="searchName" placeholder="חפש לפי שם החוק">
    <select id="searchStage"></select>
    <input type="text" id="searchProposer" placeholder="חפש לפי מציע">
    <select id="searchDays">
      <option value="7" selected>7 ימים אחרונים</option>
      <option value="30">30 ימים אחרונים</option>
      <option value="90">90 ימים אחרונים</option>
      <option value="">ללא סינון</option>
    </select>
    <button onclick="filterTable()">חפש</button>
  </div>
  <table id="lawsTable">
    <thead>
      <tr>
        <th style="width: 30%">שם החוק</th>
        <th style="width: 15%">שלב</th>
        <th style="width: 20%">שמות המציעים</th>
        <th style="width: 15%">תאריך עדכון אחרון</th>
        <th style="width: 10%">סוג</th>
        <th style="width: 10%">קישור</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    let allData = [];

    async function fetchExcel() {
      const url = 'https://raw.githubusercontent.com/gil1feldman/Knesset_laws/main/%D7%94%D7%A6%D7%A2%D7%95%D7%AA%20%D7%97%D7%95%D7%A7%20%D7%9E%D7%90%D7%95%D7%97%D7%93.xlsx';
      const response = await fetch(url);
      const arrayBuffer = await response.arrayBuffer();
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const sheet = workbook.Sheets['כנסת25'];
      const json = XLSX.utils.sheet_to_json(sheet);
      allData = json;
      populateStageOptions(json);
      renderTable(json);
      updateLastUpdateDate(json);
    }

    function populateStageOptions(data) {
      const stageSelect = document.getElementById('searchStage');
      const uniqueStages = [...new Set(data.map(row => row.stage).filter(Boolean))];
      stageSelect.innerHTML = '<option value="">שלב החקיקה</option>' +
        uniqueStages.map(stage => `<option value="${stage}">${stage}</option>`).join('');
    }

    function updateLastUpdateDate(data) {
      const dates = data
        .map(row => new Date(row.last_date))
        .filter(d => !isNaN(d));
      if (dates.length > 0) {
        const latest = new Date(Math.max(...dates));
        const formatted = latest.toLocaleDateString('he-IL');
        document.getElementById('lastUpdate').innerText = `עדכני לתאריך: ${formatted}`;
      } else {
        document.getElementById('lastUpdate').innerText = 'אין תאריכים זמינים';
      }
    }

    function renderTable(data) {
      const tbody = document.querySelector('#lawsTable tbody');
      tbody.innerHTML = '';
      data.forEach(row => {
        const proposerList = (row.knesset_members || '').split(/,|\u05E2"/).map(p => p.trim()).filter(p => p);
        const mainProposer = proposerList[0] || '';
        const otherProposers = proposerList.slice(1).join(', ');

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.name || ''}</td>
          <td>${row.stage || ''}</td>
          <td class="proposer-cell">
            ${mainProposer}
            ${otherProposers ? `<button class="show-more-btn" onclick="this.nextElementSibling.style.display='block'">+</button>
            <div class="more-proposers" onclick="this.style.display='none'">${otherProposers}</div>` : ''}
          </td>
          <td>${row.last_date || ''}</td>
          <td>${row.type || ''}</td>
          <td><a href="${row.link}" target="_blank">לצפייה</a></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function filterTable() {
      const name = document.getElementById('searchName').value.toLowerCase();
      const stage = document.getElementById('searchStage').value.toLowerCase();
      const proposer = document.getElementById('searchProposer').value.toLowerCase();
      const daysVal = document.getElementById('searchDays').value;
      const days = daysVal ? parseInt(daysVal) : null;
      const today = new Date();

      const filtered = allData.filter(row => {
        const rowName = (row.name || '').toLowerCase();
        const rowStage = (row.stage || '').toLowerCase();
        const rowProposer = (row.knesset_members || '').toLowerCase();
        const rowDate = row.last_date ? new Date(row.last_date) : null;

        return (
          (!name || rowName.includes(name)) &&
          (!stage || rowStage.includes(stage)) &&
          (!proposer || rowProposer.includes(proposer)) &&
          (!days || (rowDate && (today - rowDate) / (1000 * 60 * 60 * 24) <= days))
        );
      });

      renderTable(filtered);
    }

    fetchExcel();
  </script>
</body>
</html>
